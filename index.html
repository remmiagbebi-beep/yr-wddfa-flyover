```html
<!DOCTYPE html> 
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Crashed Plane 3D Flyover</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet" />

<style>
#iconResetView {
  width: 40px !important;
  height: 40px !important;
}
  
html,body{
  margin:0;
  height:100%;
  background:#000;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  overflow:hidden;
}
#map{ position:absolute; inset:0 }

.ui{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  z-index:10;
  display:flex;
  flex-direction:column;
  gap:18px;
}
.ui-right{ right:20px; }
.ui-left{ left:20px; }

.btn{
  width:50px;
  height:50px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  border:3px solid #fff;
  cursor:pointer;
  background:linear-gradient(180deg,#EC2629,#b51d20);
  box-shadow:0 3px 10px rgba(0,0,0,.35);
  transition:.15s;
}
.btn:hover{
  background:linear-gradient(180deg,#3899EC,#297fc8);
}

.btn svg{
  fill:#fff;
  width:24px;
  height:24px;
  display:none;
}
.btn svg.active{ display:block }

/* base size for speed icon */
#iconSpeed{
  width:18px;
  height:18px;
}

.speed-wrap{ position:relative; width:50px; height:50px }

.speed-panel{
  position:absolute;
  top:50%;
  right:60px;
  transform:translateY(-50%) scale(.98);
  opacity:0;
  pointer-events:none;
  width:230px;
  height:45px;
  display:flex;
  align-items:center;
  gap:12px;
  padding:0 10px;
  border-radius:9999px;
  border:3px solid #fff;
  background:linear-gradient(180deg,#EC2629,#b51d20);
  transition:opacity .18s,transform .18s;
  box-shadow:0 3px 10px rgba(0,0,0,.35);
}
.speed-wrap.open .speed-panel{
  opacity:1;
  transform:translateY(-50%) scale(1);
  pointer-events:auto;
}

.speed-slider{
  flex:1;
  appearance:none;
  height:6px;
  border-radius:999px;
  background:linear-gradient(90deg,#fff,#fff8);
  outline:none;
}
.speed-slider::-webkit-slider-thumb{
  appearance:none;
  width:18px;
  height:18px;
  border-radius:50%;
  background:#fff;
  border:2px solid #EC2629;
  box-shadow:0 2px 8px rgba(0,0,0,.25);
  cursor:pointer;
}

/* MOBILE MENU BUTTON – base style, visibility handled in JS */
.mobile-menu-btn{
  position:absolute;
  bottom:20px;
  right:20px;
  z-index:20;
  display:none;
}

/* Hide all Mapbox branding */
.mapboxgl-ctrl-logo,
.mapboxgl-ctrl-attrib,
.mapboxgl-ctrl-bottom-left,
.mapboxgl-ctrl-bottom-right{
  display:none !important;
}

/* Fake fullscreen hook (desktop / android) */
body.fake-fullscreen #map{
  position:fixed;
  inset:0;
  z-index:1;
}
body.fake-fullscreen .ui,
body.fake-fullscreen #btnMobileMenu{
  z-index:2;
}

/* MOBILE LAYOUT + 85% BUTTON SIZE, NO WHITE BORDERS, BACKWARDS L ALIGNMENT */
@media (max-width: 767px){

  :root{
    --btn-size:42px;
    --gap:8px;
    --menu-offset:20px;
  }

  /* all buttons 85% of desktop and NO border */
  .btn{
    width:var(--btn-size);
    height:var(--btn-size);
    border:none;
  }
  .btn svg{
    width:20px;
    height:20px;
  }

  /* speed icon 15% smaller on normal mobile (non fullscreen) */
  body:not(.ios-fullscreen) #iconSpeed{
    width:14px !important;
    height:14px !important;
  }

  #iconResetView{
    width:34px !important;
    height:34px !important;
  }

  .speed-wrap{
    width:var(--btn-size);
    height:var(--btn-size);
  }
  .speed-panel{
    height:36px;
    right:50px;
    width:185px;
    border:none;
    gap:9px;
    padding:0 7px;
  }
  .speed-slider::-webkit-slider-thumb{
    width:15px;
    height:15px;
  }

  /* menu absolutely in bottom right */
  .mobile-menu-btn{
    position:absolute;
    bottom:var(--menu-offset);
    right:var(--menu-offset);
    z-index:20;
  }

  #btnMobileMenu{
    width:var(--btn-size);
    height:var(--btn-size);
    border:none;
  }
  #btnMobileMenu svg{
    width:20px;
    height:20px;
  }

  /* backwards L: all gaps = var(--gap), edges aligned to menu */
  .ui-left,
  .ui-right{
    top:auto;
    transform:none;
    gap:var(--gap);
  }

  /* bottom row to the left of menu */
  .ui-right{
    bottom:var(--menu-offset);
    right:calc(var(--menu-offset) + var(--btn-size) + var(--gap));
    left:auto;
    flex-direction:row-reverse;
    align-items:flex-end;
  }

  /* vertical stack above menu */
  .ui-left{
    bottom:calc(var(--menu-offset) + var(--btn-size) + var(--gap));
    right:var(--menu-offset);
    left:auto;
    flex-direction:column;
    align-items:flex-end;
  }

  /* iOS FULLSCREEN TAB
     - bigger buttons, but speed icon kept small like normal mobile
  */
  body.ios-fullscreen{
    --btn-size:57px;
  }

  body.ios-fullscreen .btn svg{
    width:27px;
    height:27px;
  }

  /* KEY CHANGE: fullscreen speed icon back to small size */
  body.ios-fullscreen #iconSpeed{
    width:17px !important;
    height:17px !important;
  }

  body.ios-fullscreen #iconResetView{
    width:45px !important;
    height:45px !important;
  }
  body.ios-fullscreen .speed-panel{
    height:50px;
    right:60px;
    width:255px;
    gap:14px;
    padding:0 12px;
  }
  body.ios-fullscreen .speed-slider::-webkit-slider-thumb{
    width:20px;
    height:20px;
  }

  body.ios-fullscreen #btnFull{
    display:none !important;
  }
}
</style>
</head>

<body>
<div id="map"></div>

<!-- LEFT SIDE: play / restart / reset / camera -->
<div class="ui ui-left">

  <button id="btnToggle" class="btn">
    <svg id="iconPlay" class="active" viewBox="0 0 24 24">
      <polygon transform="translate(1,0)" points="5,3 19,12 5,21"></polygon>
    </svg>
    <svg id="iconPause" viewBox="0 0 24 24">
      <rect x="6" y="4" width="5" height="16" rx="1.5"></rect>
      <rect x="13" y="4" width="5" height="16" rx="1.5"></rect>
    </svg>
  </button>

  <button id="btnRestart" class="btn">
    <svg id="iconRestart" class="active" viewBox="0 0 24 24" style="transform:translateX(2px)">
      <path d="M5 4v5h5" fill="none" stroke="#fff" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round"></path>
      <path d="M5 9a7 7 0 1 1-1.5 4.3" fill="none" stroke="#fff" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round"></path>
    </svg>
  </button>

  <button id="btnReset" class="btn">
    <svg id="iconResetView"
       class="active"
       width="36"
       height="36"
       viewBox="0 0 512 512"
       xmlns="http://www.w3.org/2000/svg">
      <path fill="#ffffff" d="M307.81,212.18c-3.24,0-6.07-2.17-6.91-5.3l-4.82-17.88c-0.84-3.12-3.68-5.3-6.91-5.3h-21.46h-25.44H220.8
        c-3.24,0-6.07,2.17-6.91,5.3l-4.82,17.88c-0.84,3.12-3.68,5.3-6.91,5.3H169.5c-3.96,0-7.16,3.21-7.16,7.16v101.78
        c0,3.96,3.21,7.16,7.16,7.16h170.95c3.96,0,7.16-3.21,7.16-7.16V219.35c0-3.96-3.21-7.16-7.16-7.16H307.81z M282.33,264.94
        c-0.86,13.64-11.93,24.71-25.58,25.58c-16.54,1.05-30.18-12.59-29.14-29.14c0.86-13.64,11.93-24.71,25.58-25.58
        C269.74,234.76,283.38,248.4,282.33,264.94z"/>
      <path fill="#ffffff" d="M82.95,272.41c3.82,0,7.53-1.53,10.23-4.23l21.23-21.23c4.74-4.74,6.4-11.92,3.73-18.06
        c-2.73-6.29-8.88-8.95-18.84-7.57l-0.27,0.27c15.78-71.56,79.7-125.27,155.94-125.27c60.72,0,115.41,33.72,142.73,87.99
        c3.58,7.11,12.24,9.97,19.34,6.39c7.11-3.58,9.97-12.24,6.39-19.34c-15.47-30.73-39.05-56.66-68.22-75.01
        C325.23,77.47,290.57,67.5,254.98,67.5c-93,0-170.48,67.71-185.75,156.41c-5.38-4.77-13.59-5.18-19.13-0.44
        c-6.3,5.39-6.75,14.88-1.13,20.84c0.23,0.24,5.69,6.03,11.41,11.93c3.41,3.51,6.2,6.33,8.3,8.38c4.23,4.13,7.88,7.69,14.07,7.78
        C82.81,272.41,82.88,272.41,82.95,272.41z"/>
      <path fill="#ffffff" d="M464.28,247.82l-26.5-26.5c-2.75-2.75-6.57-4.3-10.44-4.23c-2.33,0.03-4.29,0.56-6.07,1.42
        c-0.26,0.12-0.51,0.26-0.76,0.4c-0.59,0.33-1.16,0.68-1.69,1.08c-1.88,1.34-3.6,3.03-5.44,4.82c-2.1,2.05-4.89,4.87-8.3,8.38
        c-5.72,5.9-11.18,11.68-11.41,11.93c-5.46,5.79-5.19,14.91,0.6,20.36c5.75,5.42,14.77,5.18,20.24-0.48
        c-4.72,83.85-74.42,150.62-159.43,150.62c-70.52,0-131.86-45.23-152.62-112.55c-2.35-7.6-10.41-11.86-18.01-9.52
        c-7.6,2.34-11.86,10.41-9.52,18.01c11.62,37.68,35.48,71.52,67.19,95.28c32.8,24.59,71.86,37.58,112.96,37.58
        c100.11,0,182.23-78.45,188.14-177.1l0.79,0.79c2.81,2.81,6.5,4.22,10.18,4.22c3.69,0,7.37-1.41,10.18-4.22
        C469.91,262.57,469.91,253.45,464.28,247.82z"/>
    </svg>
  </button>

  <button id="btnCam" class="btn">
    <svg id="iconCamCine" class="active" viewBox="0 0 24 24">
      <rect x="3" y="7" width="11" height="10" rx="2"></rect>
      <polygon points="16,10 22,7.5 22,16.5 16,14"></polygon>
    </svg>
    <svg id="iconCamBird" xmlns="http://www.w3.org/2000/svg"
         viewBox="4.3333375 6.3333375 43.875 40.375"
         style="transform:translate(1px,1px)">
      <path fill="#fff" d="M41.965,20.694c-0.495-2.083-2.273-3.54-4.182-3.54c-1.816,0-3.717,1.149-5.184,2.522
        c-3.911-5.328-9.661-9.706-13.112-12.527c-0.713,1.656-1.029,3.449-1.029,5.271c0,1.999,0.395,4.832,1.042,6.768L26,19.667H5.121
        c2.5,5.762,7.472,9.976,13.329,12.333c-3.699,2.583-6.778,4.415-10.271,6.815c2.034,2.034,3.384,2.935,6.606,4.035
        c2.205-3.185,3.991-5.396,5.582-7.654c2.219,0.988,4.734,1.532,7.207,1.532c11.183,0,14.263-12.188,14.509-14.603
        c0.972-0.161,1.946-0.328,2.918-0.455C43.971,21.4,42.953,21.075,41.965,20.694z"/>
    </svg>
  </button>
</div>

<!-- RIGHT SIDE: fullscreen / zoom / layers / speed -->
<div class="ui ui-right">

  <button id="btnFull" class="btn">
    <svg id="iconFull" class="active" viewBox="0 0 24 24">
      <polyline points="4,9 4,4 9,4" fill="none" stroke="#fff" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"></polyline>
      <polyline points="20,9 20,4 15,4" fill="none" stroke="#fff" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"></polyline>
      <polyline points="4,15 4,20 9,20" fill="none" stroke="#fff" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"></polyline>
      <polyline points="20,15 20,20 15,20" fill="none" stroke="#fff" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"></polyline>
    </svg>
  </button>

  <button id="btnZoomIn" class="btn">
    <svg id="iconZoomIn" class="active" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="7" stroke="#fff" stroke-width="2" fill="none"></circle>
      <line x1="11" y1="8" x2="11" y2="14" stroke="#fff" stroke-width="2"></line>
      <line x1="8" y1="11" x2="14" y2="11" stroke="#fff" stroke-width="2"></line>
      <line x1="16" y1="16" x2="21" y2="21" stroke="#fff" stroke-width="2"></line>
    </svg>
  </button>

  <button id="btnZoomOut" class="btn">
    <svg id="iconZoomOut" class="active" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="7" stroke="#fff" stroke-width="2" fill="none"></circle>
      <line x1="8" y1="11" x2="14" y2="11" stroke="#fff" stroke-width="2"></line>
      <line x1="16" y1="16" x2="21" y2="21" stroke="#fff" stroke-width="2"></line>
    </svg>
  </button>

  <button id="btnLayers" class="btn">
    <svg id="iconLayers" class="active"></svg>
  </button>

  <div class="speed-wrap" id="speedWrap">
    <button id="btnSpeed" class="btn">
      <svg id="iconSpeed" class="active" viewBox="0 0 24 24">
        <path d="M4 5l8 7-8 7V5zm9 0l8 7-8 7V5z"></path>
      </svg>
    </button>

    <div class="speed-panel" id="speedPanel">
      <input id="speed" class="speed-slider"
             type="range" min="0.1" max="5" step="0.05" value="0.35">
    </div>
  </div>
</div>

<!-- MOBILE MENU BUTTON -->
<button id="btnMobileMenu" class="btn mobile-menu-btn">
  <svg id="iconMobileMenu" class="active" viewBox="0 0 24 24">
    <circle cx="6" cy="12" r="2"></circle>
    <circle cx="12" cy="12" r="2"></circle>
    <circle cx="18" cy="12" r="2"></circle>
  </svg>
</button>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.0/dist/togeojson.umd.js"></script>

<script>
mapboxgl.accessToken="pk.eyJ1IjoicmVtbWlhZ2JlYmkiLCJhIjoiY21odHRrYTQzMTk0bjJqcjE1b2xhZ2FraSJ9.nTCz33gX0gQt3T4A6VD0oQ";

const GPX_URL="https://raw.githubusercontent.com/remmiagbebi-beep/crashed-plane-flyover/refs/heads/main/The%20Crashed%20Plane%20Hike%20-%20GPX.gpx";

const START_ZOOM=15.7,
      CENTER_SMOOTH=0.06,
      MAX_TURN_RATE=4,
      STEP_KM=0.02;

let currentZoom = START_ZOOM;
let targetZoom  = START_ZOOM;

function forceWhite(svg){
  svg.querySelectorAll("*").forEach(n=>{
    if(n.getAttribute("fill")!=="none") n.setAttribute("fill","#fff");
    if(n.hasAttribute("stroke")) n.setAttribute("stroke","#fff");
  });
}

/* FAST FORWARD ICON */
(async()=>{
  try{
    const r=await fetch("https://raw.githubusercontent.com/remmiagbebi-beep/crashed-plane-flyover/main/icons/fast-forward.svg");
    const t=await r.text();
    const svg=new DOMParser().parseFromString(t,"image/svg+xml").querySelector("svg");
    if(svg){
      forceWhite(svg);
      svg.id="iconSpeed";
      svg.classList.add("active");
      svg.style.width="18px";
      svg.style.height="18px";
      document.getElementById("iconSpeed").replaceWith(svg);
    }
  }catch(e){}
})();

/* LAYERS ICON */
(async()=>{
  try{
    const r=await fetch("https://raw.githubusercontent.com/remmiagbebi-beep/crashed-plane-flyover/main/icons/layers.svg");
    const t=await r.text();
    const svg=new DOMParser().parseFromString(t,"image/svg+xml").querySelector("svg");
    if(svg){
      forceWhite(svg);
      svg.id="iconLayers";
      svg.classList.add("active");
      svg.style.width="24px";
      svg.style.height="24px";
      document.getElementById("iconLayers").replaceWith(svg);
    }
  }catch(e){}
})();

const map=new mapboxgl.Map({
  container:"map",
  style:"mapbox://styles/mapbox/satellite-streets-v12",
  center:[-1.8743,53.3832],
  zoom:START_ZOOM,
  pitch:75,
  bearing:-20,
  antialias:true,
  attributionControl:false
});

let route=null,routeLen=0,progress=0,playing=false,camMode="follow";
let userOverride=false;
let camCenter=null,camBearing=null,lastTs=0;
let osVisible=false;

async function fetchText(u){
  try{const r=await fetch(u);if(r.ok)return await r.text();}catch(e){}
  try{const r=await fetch("https://corsproxy.io/?"+encodeURIComponent(u));if(r.ok)return await r.text();}catch(e){}
  return "";
}
function parseGpx(text){
  const xml=new DOMParser().parseFromString(text,"application/xml");
  return toGeoJSON.gpx(xml).features.find(f=>f.geometry?.type==="LineString");
}
async function addArrow(){
  if(map.hasImage("arrow"))return;
  const c=document.createElement("canvas");
  c.width=c.height=96;
  const ctx=c.getContext("2d");
  ctx.translate(48,48);
  ctx.beginPath();
  ctx.moveTo(40,0);
  ctx.lineTo(-24,-25);
  ctx.lineTo(-24,25);
  ctx.closePath();
  ctx.strokeStyle="#EC2629";
  ctx.fillStyle="#fff";
  ctx.lineWidth=3;
  ctx.stroke();
  ctx.fill();
  map.addImage("arrow",await createImageBitmap(c),{pixelRatio:2});
}

map.on("load",async()=>{

  map.addSource("mapbox-dem",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1"});
  map.setTerrain({source:"mapbox-dem",exaggeration:1});
  map.addLayer({id:"sky",type:"sky",
    paint:{"sky-type":"atmosphere","sky-atmosphere-sun-intensity":12}
  });

  map.addSource("os-topo",{
    type:"raster",
    tiles:[
      "https://a.tile.opentopomap.org/{z}/{x}/{y}.png",
      "https://b.tile.opentopomap.org/{z}/{x}/{y}.png",
      "https://c.tile.opentopomap.org/{z}/{x}/{y}.png"
    ],
    tileSize:256,
    maxzoom:17
  });
  map.addLayer({
    id:"os-topo-layer",
    type:"raster",
    source:"os-topo",
    layout:{ visibility:"none" },
    paint:{}
  });

  map.addSource("route",{type:"geojson",data:{type:"FeatureCollection",features:[]}});
  map.addLayer({
    id:"route-line",
    type:"line",
    source:"route",
    paint:{
      "line-color":"#EC2629",
      "line-width":4,
      "line-opacity":0.95
    }
  });

  await addArrow();

  map.addLayer({
    id:"route-arrows",
    type:"symbol",
    source:"route",
    layout:{
      "symbol-placement":"line",
      "symbol-spacing":110,
      "icon-image":"arrow",
      "icon-size":0.45,
      "icon-allow-overlap":true,
      "icon-ignore-placement":true,
      "icon-rotation-alignment":"map",
      "icon-keep-upright":false
    },
    paint:{"icon-opacity":0.9}
  });

  map.addSource("cursor",{type:"geojson",data:turf.point([0,0])});
  map.addLayer({
    id:"cursor-pt",
    type:"circle",
    source:"cursor",
    paint:{
      "circle-radius":6,
      "circle-color":"#fff",
      "circle-stroke-width":3,
      "circle-stroke-color":"#EC2629"
    }
  });

  const text=await fetchText(GPX_URL);
  const line=parseGpx(text);
  if(line){
    const len=turf.length(line,{units:"kilometers"});
    const pts=[];
    for(let d=0;d<=len;d+=STEP_KM){
      pts.push(
        turf.along(line,Math.min(d,len),{units:"kilometers"}).geometry.coordinates
      );
    }
    route={type:"Feature",geometry:{type:"LineString",coordinates:pts}};
    routeLen=len;

    map.getSource("route").setData(route);
    map.getSource("cursor").setData(turf.point(pts[0]));

    map.once("idle",()=>{
      const b=turf.bbox(route);
      map.fitBounds([[b[0],b[1]],[b[2],b[3]]],{
        padding:80,pitch:75,bearing:-20,duration:0
      });
      currentZoom = START_ZOOM;
      targetZoom  = START_ZOOM;
    });
  }

  requestAnimationFrame(tick);
});

function camIcons(){
  return{
    follow:document.getElementById("iconCamCine"),
    topdown:document.getElementById("iconCamBird")
  };
}

document.getElementById("btnToggle").onclick=()=>{
  playing=!playing;
  if(playing){
    userOverride=false;
    camCenter=null;
    camBearing=null;
    currentZoom = START_ZOOM;
    targetZoom  = START_ZOOM;
  }
  document.getElementById("iconPlay").classList.toggle("active",!playing);
  document.getElementById("iconPause").classList.toggle("active",playing);
};

document.getElementById("btnRestart").onclick=()=>{
  if(!route) return;
  progress=0;
  const startCoord=route.geometry.coordinates[0];
  map.getSource("cursor").setData(turf.point(startCoord));
  camCenter=null;
  camBearing=null;
  currentZoom = START_ZOOM;
  targetZoom  = START_ZOOM;
};

document.getElementById("btnReset").onclick=()=>{
  if(!route) return;
  userOverride=false;
  camMode="follow";
  camCenter=null;
  camBearing=null;
  const icons=camIcons();
  Object.values(icons).forEach(i=>i.classList.remove("active"));
  icons.follow.classList.add("active");
  currentZoom = START_ZOOM;
  targetZoom  = START_ZOOM;
};

const btnCam=document.getElementById("btnCam");
btnCam.onclick=()=>{
  camMode = (camMode === "follow") ? "topdown" : "follow";
  const icons=camIcons();
  Object.values(icons).forEach(i=>i.classList.remove("active"));
  icons[camMode].classList.add("active");

  userOverride=false;
  camCenter=null;
  camBearing=null;
  currentZoom = START_ZOOM;
  targetZoom  = START_ZOOM;
};

document.getElementById("btnLayers").onclick=()=>{
  osVisible=!osVisible;
  map.setLayoutProperty("os-topo-layer","visibility",osVisible?"visible":"none");
};

const speedWrap=document.getElementById("speedWrap");
document.getElementById("btnSpeed").onclick=e=>{
  e.stopPropagation();
  speedWrap.classList.toggle("open");
};
document.addEventListener("click",()=>speedWrap.classList.remove("open"));

/* Fullscreen:
   - iOS: open same page in new tab with ?fs=1 (fullscreen layout)
   - others: real Fullscreen API
*/
const btnFull=document.getElementById("btnFull");

function isFullscreen(){
  return document.fullscreenElement || document.webkitFullscreenElement ||
         document.mozFullScreenElement || document.msFullscreenElement;
}

function isIOS(){
  const ua = window.navigator.userAgent || "";
  const platform = window.navigator.platform || "";
  const iOS = /iPad|iPhone|iPod/.test(ua);
  const iPadOS = platform === "MacIntel" && navigator.maxTouchPoints > 1;
  return iOS || iPadOS;
}

/* Detect iOS fullscreen tab via ?fs=1 and set class */
(function(){
  const params = new URLSearchParams(window.location.search);
  if(isIOS() && params.get("fs") === "1"){
    document.body.classList.add("ios-fullscreen");
    const bf = document.getElementById("btnFull");
    if(bf) bf.style.display = "none";
  }
})();

btnFull.onclick=()=>{
  if(isIOS()){
    const url = new URL(window.location.href);
    url.searchParams.set("fs","1");
    window.open(url.toString(), "_blank");
    return;
  }

  if(!isFullscreen()){
    const el=document.documentElement;
    if(el.requestFullscreen) el.requestFullscreen();
    else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    else if(el.mozRequestFullScreen) el.mozRequestFullScreen();
    else if(el.msRequestFullscreen) el.msRequestFullscreen();
  }else{
    if(document.exitFullscreen) document.exitFullscreen();
    else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
    else if(document.mozCancelFullScreen) document.mozCancelFullScreen();
    else if(document.msExitFullscreen) document.msExitFullscreen();
  }
};

document.getElementById("btnZoomIn").onclick=()=>{
  const delta=0.7;
  if(playing && (camMode==="follow"||camMode==="topdown") && !userOverride){
    targetZoom = Math.min(targetZoom + delta, 19);
  }else{
    const z = map.getZoom()+delta;
    map.easeTo({ zoom:z, duration:600 });
    currentZoom = z;
    targetZoom  = z;
  }
};
document.getElementById("btnZoomOut").onclick=()=>{
  const delta=0.7;
  if(playing && (camMode==="follow"||camMode==="topdown") && !userOverride){
    targetZoom = Math.max(targetZoom - delta, 4);
  }else{
    const z = map.getZoom()-delta;
    map.easeTo({ zoom:z, duration:600 });
    currentZoom = z;
    targetZoom  = z;
  }
};

["mousedown","touchstart","dragstart","rotatestart","zoomstart","pitchstart"].forEach(ev=>{
  map.on(ev,e=>{
    if(!e.originalEvent) return;
    if(playing && (camMode==="follow"||camMode==="topdown")){
      userOverride=true;
    }
  });
});

function tick(ts){
  if(!lastTs) lastTs=ts;
  const dt=(ts-lastTs)/1000;
  lastTs=ts;

  if(playing && route){
    const speed=parseFloat(document.getElementById("speed").value||"0.35");
    progress+=speed*dt*0.28;
    if(progress>routeLen) progress=0;

    const pos=turf.along(route,progress,{units:"kilometers"}).geometry.coordinates;
    const nxt=turf.along(route,Math.min(progress+0.01,routeLen),{units:"kilometers"}).geometry.coordinates;

    map.getSource("cursor").setData(turf.point(pos));

    if((camMode==="follow" || camMode==="topdown") && !userOverride){
      const targetCenter=pos;
      const targetBearing=turf.bearing(turf.point(pos),turf.point(nxt));
      const targetPitch=camMode==="topdown"?0:75;

      if(camBearing===null) camBearing=targetBearing;
      const diff=((targetBearing-camBearing+540)%360)-180;
      camBearing+=Math.max(-MAX_TURN_RATE*dt,Math.min(MAX_TURN_RATE*dt,diff));

      if(!camCenter) camCenter=targetCenter;
      camCenter=[
        camCenter[0]+(targetCenter[0]-camCenter[0])*CENTER_SMOOTH,
        camCenter[1]+(targetCenter[1]-camCenter[1])*CENTER_SMOOTH
      ];

      const dz = targetZoom - currentZoom;
      const zoomLerp = Math.min(1, 3*dt);
      currentZoom = currentZoom + dz*zoomLerp;

      map.jumpTo({
        center:camCenter,
        bearing:camBearing,
        pitch:targetPitch,
        zoom:currentZoom
      });
    }
  }

  requestAnimationFrame(tick);
}

/* MOBILE MENU TOGGLE – Layers + Speed in vertical stack on mobile,
   menu stays separate in bottom right */
(function(){
  const btnMobileMenu = document.getElementById("btnMobileMenu");
  const uiLeft = document.querySelector(".ui-left");
  const uiRight = document.querySelector(".ui-right");
  if(!btnMobileMenu || !uiLeft || !uiRight) return;

  const isMobile = window.matchMedia("(max-width: 767px)").matches;

  function setControlsVisible(v){
    const disp = v ? "flex" : "none";
    uiLeft.style.display = disp;
    uiRight.style.display = disp;
  }

  if(isMobile){
    const speedWrapEl  = document.getElementById("speedWrap");
    const layersBtnEl  = document.getElementById("btnLayers");

    if(layersBtnEl){
      uiLeft.appendChild(layersBtnEl);
    }
    if(speedWrapEl){
      uiLeft.appendChild(speedWrapEl);
    }

    btnMobileMenu.style.display = "flex";
    setControlsVisible(false);
    let visible = false;
    btnMobileMenu.addEventListener("click",()=>{
      visible = !visible;
      setControlsVisible(visible);
    });
  }else{
    setControlsVisible(true);
    btnMobileMenu.style.display = "none";
  }
})();
</script>

</body>
</html>
```
